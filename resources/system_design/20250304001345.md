## Implementation approach

本项目将采用 React + FastAPI + Reactflow + Langchain 的技术栈。Reactflow 提供可视化流程图编辑能力，FastAPI 构建后端 API，Langchain 结合 LLM API 实现自然语言生成/修改节点的功能。难点在于如何将自然语言指令准确地转换为 Reactflow 节点和属性的修改，以及如何处理复杂的流程图逻辑和数据流。我们将采用以下策略：

1.  **自然语言处理模块：** 使用 Langchain 结合 LLM API，训练一个专门用于理解流程图节点生成和修改指令的模型。该模型需要能够识别节点类型、属性、连接关系等信息。
2.  **流程图逻辑处理：** 设计一套清晰的流程图数据结构，方便进行节点的增删改查和连接关系的维护。同时，需要考虑流程图的执行逻辑和数据流的传递。
3.  **Reactflow 集成：** 深入理解 Reactflow 的 API 和事件机制，实现节点拖拽、连接、属性编辑等功能。同时，需要定制化 Reactflow 的样式和交互，使其更符合用户的使用习惯。
4.  **全局变量管理：** 实现一个全局变量管理器，支持 JSON 格式的外部文件导入和导出。全局变量可以在流程图的节点中使用，方便进行数据共享和参数配置。
5.  **会话管理：** 使用 JWT 进行用户认证，并将会话信息（包括流程图数据、对话历史、全局变量等）存储到数据库中。用户登录后，可以恢复之前的会话状态。
6.  **多语言支持：** 使用 i18n 库实现多语言支持，方便不同语言的用户使用。

## File list

- frontend/src/App.js
- frontend/src/components/FlowEditor.js
- frontend/src/components/Sidebar.js
- frontend/src/components/NodeSelector.js
- frontend/src/components/NodeProperties.js
- frontend/src/components/GlobalVariables.js
- frontend/src/components/ChatInterface.js
- frontend/src/api/api.js
- backend/app/main.py
- backend/app/routers/flow.py
- backend/app/routers/llm.py
- backend/app/routers/user.py
- backend/app/models.py
- backend/app/database.py
- backend/app/config.py

## Data structures and interfaces


classDiagram
    class FlowEditor {
        -nodes: list
        -edges: list
        -selectedNode: Node
        +addNode(node: Node)
        +updateNode(node: Node)
        +removeNode(nodeId: str)
        +addEdge(edge: Edge)
        +removeEdge(edgeId: str)
        +loadFlow(flowData: dict)
        +saveFlow() dict
        +onNodeClick(node: Node)
    }
    class Node {
        -id: str
        -type: str
        -data: dict
        -position: dict
        +Node(id: str, type: str, data: dict, position: dict)
        +getData() dict
        +setData(data: dict)
    }
    class Edge {
        -id: str
        -source: str
        -target: str
        -sourceHandle: str
        -targetHandle: str
        +Edge(id: str, source: str, target: str, sourceHandle: str, targetHandle: str)
    }
    class Sidebar {
        +addNodeByType(nodeType: str)
    }
    class NodeSelector {
        +getNodeTypes() list
    }
    class NodeProperties {
        -node: Node
        +updateNodeProperty(property: str, value: any)
    }
    class GlobalVariables {
        -variables: dict
        +loadVariables(filePath: str)
        +saveVariables(filePath: str)
        +getVariable(name: str) any
        +setVariable(name: str, value: any)
    }
    class ChatInterface {
        +sendMessage(message: str) str
        +getChatHistory() list
    }
    class FastAPI {
        +create_flow(flow_data: dict) dict
        +get_flow(flow_id: str) dict
        +update_flow(flow_id: str, flow_data: dict) dict
        +delete_flow(flow_id: str) dict
        +generate_node(prompt: str) dict
        +update_node_by_llm(node_id: str, prompt: str) dict
        +login(user_data: dict) dict
        +register(user_data: dict) dict
    }

    FlowEditor -- Node : contains
    FlowEditor -- Edge : contains
    FlowEditor -- Sidebar : uses
    FlowEditor -- NodeProperties : uses
    FlowEditor -- GlobalVariables : uses
    FlowEditor -- ChatInterface : uses
    Sidebar -- NodeSelector : uses


## Program call flow


sequenceDiagram
    participant FE as FlowEditor
    participant SB as Sidebar
    participant NS as NodeSelector
    participant NP as NodeProperties
    participant GV as GlobalVariables
    participant CI as ChatInterface
    participant API as FastAPI
    participant DB as Database

    # Initial Flow Load
    FE->>API: get_flow(flow_id)
    API->>DB: query_flow(flow_id)
    DB-->>API: return flow_data
    API-->>FE: return flow_data
    FE->>FE: loadFlow(flow_data)

    # Add Node from Sidebar
    SB->>NS: getNodeTypes()
    NS-->>SB: return nodeTypes
    SB->>FE: addNodeByType(nodeType)
    FE->>FE: create Node(nodeType)
    FE->>FE: addNode(node)
    FE->>FE: render()

    # Select Node and Edit Properties
    FE->>FE: onNodeClick(node)
    FE->>NP: display properties of node
    NP->>FE: updateNodeProperty(property, value)
    FE->>FE: updateNode(node)
    FE->>FE: render()

    # Use Chat Interface to Generate Node
    CI->>API: sendMessage(prompt)
    API->>API: generate_node(prompt)
    API->>FE: return new node data
    FE->>FE: addNode(node)
    FE->>FE: render()

    # Save Flow
    FE->>API: saveFlow()
    API->>DB: update_flow(flow_id, flow_data)
    DB-->>API: return success
    API-->>FE: return success

    # Global Variables
    GV->>GV: loadVariables(filePath)
    GV->>GV: getVariable(name)
    GV->>GV: setVariable(name, value)


## Anything UNCLEAR

需要明确 LLM API 的具体接口和参数，以及如何将自然语言转换为符合 Reactflow 节点和属性的数据结构。例如，`generate_node(prompt)` 接口返回的数据结构是什么样的？如何将自然语言描述的节点属性映射到 Reactflow 的节点数据中？另外，关于用户认证和会话管理，需要确定具体的数据库方案和安全策略。

