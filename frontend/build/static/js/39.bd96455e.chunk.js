"use strict";(self.webpackChunkvisual_workflow_editor_frontend=self.webpackChunkvisual_workflow_editor_frontend||[]).push([[39],{8420:(e,t,s)=>{s.r(t),s.d(t,{default:()=>Z});var a=s(9950),n=s(6491),o=s(2647);const r=async(e,t)=>{const s=(new Date).toISOString().replace(/[:.]/g,"-"),a={flow_id:e,name:t||`chat-${s}`,chat_data:{messages:[]}};return(await o.u.post("/chats/",a)).data},i=async e=>(await o.u.get(`/chats/${e}`)).data,l=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;return(await o.u.get(`/chats/flow/${e}`,{params:{skip:t,limit:s}})).data},c=async(e,t)=>(await o.u.put(`/chats/${e}`,t)).data,d=async e=>(await o.u.delete(`/chats/${e}`),!0),u=async(e,t)=>{try{await o.u.post(`/flows/${e}/set_last_chat`,{chat_id:t}),console.log(`Updated last active chat for flow ${e} to ${t} via POST /flows/${e}/set_last_chat`)}catch(s){console.error(`Failed to update last active chat for flow ${e} using POST /flows/${e}/set_last_chat:`,s)}},g=(e,t,s,a,n,r)=>{const i=`${o.J}/chats/${e}/messages/${t}`,l=`${o.J}/chats/${e}/events`,c={new_content:s};let d=null;const u=()=>{d&&(console.log(`Closing EventSource connection to ${l} (from editUserMessage API utility)`),d.close(),d=null,r())};return(async()=>{try{const t=localStorage.getItem("access_token"),s={"Content-Type":"application/json"};t&&(s.Authorization=`Bearer ${t}`),console.log(`editUserMessage API: Triggering backend with PUT ${i}`);const o=await fetch(i,{method:"PUT",headers:s,body:JSON.stringify(c)});if(!o.ok){let t={message:`Edit PUT request failed! Status: ${o.status}`};try{t={...t,...await o.json()}}catch(e){t.details=await o.text()}return console.error("editUserMessage API: Edit PUT request failed:",t),n(new Error(t.detail||t.message)),void r()}if(202!==o.status){console.warn(`editUserMessage API: Edit PUT returned status ${o.status}, expected 202 if SSE is to follow. Handling as non-SSE success for now.`);try{const e=await o.json();a({type:"custom_edit_complete_no_sse",data:e})}catch(e){console.error("editUserMessage API: Failed to parse response body after non-202 success: ",e),n(new Error(`Edit succeeded with status ${o.status} but response parsing failed.`))}return void r()}console.log(`editUserMessage API: Edit PUT successful (status ${o.status}). Starting EventSource for subsequent agent response.`),d=new EventSource(l),d.onopen=()=>{console.log(`EventSource (for editUserMessage) connected to ${l}`)},d.onerror=e=>{if(console.error("EventSource (for editUserMessage) failed:",e),d&&d.readyState===EventSource.CLOSED)console.log("EventSource (for editUserMessage) closed by server, likely after stream_end.");else{const t=new Error("EventSource (for editUserMessage) connection error.");t.originalEvent=e,n(t),u()}};const g=t=>{var s;null===(s=d)||void 0===s||s.addEventListener(t,(s=>{try{let e;if("token"===t)e=s.data;else try{e=JSON.parse(s.data)}catch(o){return console.error(`Error parsing JSON for event type ${t} (editUserMessage):`,s.data,o),void n(new Error(`Failed to parse JSON data for ${t}: ${o}`))}a({type:t,data:e}),"stream_end"===t&&(console.log("Received stream_end event (editUserMessage). Closing connection."),u())}catch(e){console.error(`Error processing SSE event ${t} (editUserMessage):`,s.data,e),n(new Error(`Failed processing event ${t}: ${e}`))}}))};g("token"),g("tool_start"),g("tool_end"),g("stream_end"),g("error"),g("ping"),g("user_message_saved")}catch(t){console.error("editUserMessage API: Error during startProcessingAndStreaming:",t),n(t instanceof Error?t:new Error("Failed to initiate chat edit and stream: "+String(t))),r()}})(),u},h=function(e,t,s,a,n){let r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"user",i=arguments.length>6?arguments[6]:void 0;const l=`${o.J}/chats/${e}/messages`,c=`${o.J}/chats/${e}/events`,d={content:t,role:r};i&&(d.client_message_id=i);let u=null;const g=()=>{u&&(console.log(`Closing EventSource connection to ${c}`),u.close(),u=null,n())};return(async()=>{try{const t=localStorage.getItem("access_token"),o={"Content-Type":"application/json"};t&&(o.Authorization=`Bearer ${t}`),console.log(`sendMessage: Triggering backend with POST ${l}`);const r=await fetch(l,{method:"POST",headers:o,body:JSON.stringify(d)});if(!r.ok){let t={message:`Trigger POST failed! Status: ${r.status}`};try{t={...t,...await r.json()}}catch(e){t.details=await r.text()}return console.error("sendMessage: Trigger POST failed:",t),a(new Error(t.detail||t.message)),void n()}202!==r.status&&console.warn(`sendMessage: Trigger POST returned status ${r.status}, expected 202.`),console.log(`sendMessage: Trigger POST successful (status ${r.status}). Starting EventSource.`),u=new EventSource(c),u.onopen=()=>{console.log(`EventSource connected to ${c}`)},u.onerror=e=>{if(console.error("EventSource failed:",e),u&&u.readyState===EventSource.CLOSED)console.log("EventSource closed by server, likely after stream_end.");else{const t=new Error("EventSource connection error.");t.originalEvent=e,a(t),g()}};const i=t=>{var n;null===(n=u)||void 0===n||n.addEventListener(t,(n=>{try{let e;if("token"===t)e=n.data;else try{e=JSON.parse(n.data)}catch(o){return console.error(`Error parsing JSON for event type ${t}:`,n.data,o),void a(new Error(`Failed to parse JSON data for ${t}: ${o}`))}console.log(`Received event [${t}]:`,e),s({type:t,data:e}),"stream_end"===t&&(console.log("Received stream_end event. Closing connection."),g())}catch(e){console.error(`Error processing SSE event ${t}:`,n.data,e),a(new Error(`Failed processing event ${t}: ${e}`))}}))};i("token"),i("tool_start"),i("tool_end"),i("stream_end"),i("error"),i("user_message_saved")}catch(t){console.error("Error starting chat stream:",t),a(t instanceof Error?t:new Error("Failed to start chat stream: "+String(t))),n()}})(),g};var m=s(7648);var f=s(6639),p=s(2053),C=s(226),v=s(2235),x=s(165),S=s(7869),y=s(5333),w=s(3759),b=s(6835),E=s(379),A=s(236),$=s(4414);const k=e=>{let{editingMessageContent:t,isSending:s,onContentChange:a,onConfirmEdit:o,onCancelEdit:r}=e;return(0,$.jsxs)(n.A,{sx:{display:"flex",flexDirection:"column",gap:1,width:"100%"},children:[(0,$.jsx)(A.A,{fullWidth:!0,multiline:!0,value:t,onChange:e=>a(e.target.value),autoFocus:!0,onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),o()),"Escape"===e.key&&r()},sx:{backgroundColor:"white",borderRadius:"4px",".MuiInputBase-input":{color:"black"}}}),(0,$.jsxs)(n.A,{sx:{display:"flex",justifyContent:"flex-end",gap:1,mt:1},children:[(0,$.jsx)(C.A,{size:"small",variant:"outlined",onClick:r,sx:{color:"primary.contrastText",borderColor:"primary.contrastText"},children:"\u53d6\u6d88"}),(0,$.jsx)(C.A,{size:"small",variant:"contained",onClick:o,disabled:s,color:"secondary",children:s?(0,$.jsx)(f.A,{size:20}):"\u4fdd\u5b58"})]})]})},M=e=>{let{messages:t,activeChatId:s,isLoadingChat:o,editingMessageTimestamp:r,editingMessageContent:i,isSending:l,onNodeSelect:c,onStartEditMessage:d,onEditingContentChange:u,onConfirmEditMessage:g,onCancelEditMessage:h}=e;const m=(0,a.useRef)(null);(0,a.useEffect)((()=>{var e;null===(e=m.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[t]);const A=e=>{if("tool_status"===e.type)return(0,$.jsxs)(n.A,{sx:{display:"flex",flexDirection:"column",gap:.5},children:[(0,$.jsxs)(n.A,{sx:{display:"flex",alignItems:"center",gap:1},children:["running"===e.toolStatus&&(0,$.jsx)(f.A,{size:16}),"completed"===e.toolStatus&&(0,$.jsx)(w.A,{fontSize:"small",color:"success"}),"error"===e.toolStatus&&(0,$.jsx)(b.A,{fontSize:"small",color:"error"}),(0,$.jsxs)(p.A,{variant:"body2",component:"span",sx:{fontWeight:"bold"},children:["Tool: ",e.toolName||"Unknown Tool"]}),(0,$.jsxs)(p.A,{variant:"caption",component:"span",children:["(",e.toolStatus,")"]})]}),"completed"===e.toolStatus&&e.toolOutputSummary&&(0,$.jsxs)(p.A,{variant:"body2",sx:{pl:3,whiteSpace:"pre-wrap"},children:["Output: ",e.toolOutputSummary]}),"error"===e.toolStatus&&e.toolErrorMessage&&(0,$.jsxs)(p.A,{variant:"body2",color:"error",sx:{pl:3,whiteSpace:"pre-wrap"},children:["Error: ",e.toolErrorMessage]})]});if("error"===e.type)return(0,$.jsx)(p.A,{color:"error",sx:{fontWeight:400},children:e.content});const t=e.content.split(/(\[Node: [a-zA-Z0-9_-]+\])/g);return(0,$.jsxs)($.Fragment,{children:[t.map(((e,t)=>{const s=e.match(/\[Node: ([a-zA-Z0-9_-]+)\]/);if(s){const e=s[1];return(0,$.jsxs)(C.A,{size:"small",variant:"text",onClick:()=>c(e),sx:{p:0,minWidth:"auto",verticalAlign:"baseline",textTransform:"none",display:"inline",lineHeight:"inherit",fontWeight:400},children:["(Node: ",e,")"]},t)}return(0,$.jsx)("span",{style:{whiteSpace:"pre-wrap",fontWeight:400},children:e},t)})),e.isStreaming&&"text"===e.type&&(0,$.jsx)(f.A,{size:12,sx:{ml:1,verticalAlign:"middle"}})]})},M=!!s;return(0,$.jsxs)(v.A,{elevation:0,sx:{flex:1,overflow:"auto",p:2,mb:1,backgroundColor:"#f3f4f6",position:"relative",scrollBehavior:"smooth",overscrollBehaviorY:"contain",...!M&&{opacity:.6}},children:[o&&(0,$.jsx)(n.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:(0,$.jsx)(f.A,{})}),!o&&!M&&(0,$.jsxs)(n.A,{sx:{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",height:"100%",textAlign:"center",p:2},children:[(0,$.jsx)(p.A,{variant:"h6",gutterBottom:!0,sx:{color:"black",fontWeight:600},children:"\u8bf7\u9009\u62e9\u6216\u521b\u5efa\u804a\u5929"}),(0,$.jsx)(p.A,{sx:{color:"#4b5563",fontWeight:300},children:'\u4ece\u5de6\u4fa7\u4fa7\u8fb9\u680f\u9009\u62e9\u4e00\u4e2a\u804a\u5929\uff0c\u6216\u70b9\u51fb"\u65b0\u5efa\u804a\u5929"\u5f00\u59cb\u3002'})]}),!o&&M&&0===t.length&&(0,$.jsx)(n.A,{sx:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%"},children:(0,$.jsx)(p.A,{sx:{color:"#4b5563",fontWeight:300},children:"\u5f00\u59cb\u5bf9\u8bdd\u5427\uff01"})}),!o&&t.length>0&&t.map(((e,t)=>(0,$.jsx)(x.A,{in:!0,timeout:500,children:(0,$.jsx)(n.A,{id:`message-${e.timestamp}`,sx:{display:"flex",justifyContent:"user"===e.role?"flex-end":"flex-start",mb:1.5,..."user"===e.role&&{position:"relative"}},children:(0,$.jsxs)(v.A,{elevation:0,sx:{paddingTop:1.5,paddingBottom:1.5,paddingLeft:1.5,paddingRight:"user"===e.role?4.5:1.5,borderRadius:"16px",background:"user"===e.role?"linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)":"#ffffff",color:"user"===e.role?"white":"black",boxShadow:"user"===e.role?"0 2px 8px rgba(37, 99, 235, 0.3)":"0 2px 8px rgba(0, 0, 0, 0.08)",maxWidth:"80%",wordWrap:"break-word",whiteSpace:"pre-wrap",position:"relative"},children:[r===e.timestamp&&"user"===e.role?(0,$.jsx)(k,{editingMessageContent:i,isSending:l,onContentChange:u,onConfirmEdit:g,onCancelEdit:h}):A(e),"user"===e.role&&e.timestamp&&!e.timestamp.startsWith("user-edited-")&&r!==e.timestamp&&(0,$.jsx)(S.A,{title:"\u7f16\u8f91\u6b64\u6d88\u606f",children:(0,$.jsx)(y.A,{size:"small",onClick:()=>d(e),sx:{position:"absolute",top:"4px",right:"4px",width:24,height:24,color:"primary.contrastText",backgroundColor:"rgba(0,0,0,0.1)","&:hover":{backgroundColor:"rgba(0,0,0,0.2)"}},children:(0,$.jsx)(E.A,{fontSize:"small"})})})]})},e.timestamp)},`grow-${e.timestamp}`))),(0,$.jsx)("div",{ref:m})]})};var I=s(1673);const j=e=>{let{inputMessage:t,inputDisabled:s,isSending:a,editingMessageTimestamp:o,onInputChange:r,onSendMessage:i,onKeyPress:l,hasActiveChat:c}=e;return(0,$.jsxs)(n.A,{sx:{display:"flex",alignItems:"flex-end",gap:1,mt:"auto",padding:"12px 16px",borderTop:"1px solid #e0e0e0"},children:[(0,$.jsx)(A.A,{fullWidth:!0,multiline:!0,minRows:1,maxRows:5,value:t,onChange:e=>r(e.target.value),onKeyPress:l,placeholder:c?"\u8f93\u5165\u6d88\u606f (Shift+Enter \u6362\u884c)":"\u8bf7\u5148\u9009\u62e9\u4e00\u4e2a\u804a\u5929",disabled:s||!!o,sx:{backgroundColor:"#ffffff",borderRadius:"24px",boxShadow:"0 1px 3px rgba(0,0,0,0.06)","& .MuiOutlinedInput-root":{borderRadius:"24px",padding:"10px 15px","& fieldset":{border:"none"}},"& .MuiInputBase-input":{color:"black"}}}),(0,$.jsx)(C.A,{variant:"contained",onClick:i,disabled:s||!t.trim(),sx:{minWidth:"auto",padding:"0px",borderRadius:"50%",height:"42px",width:"42px",background:"linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)",boxShadow:"0 1px 3px rgba(0,0,0,0.1)","&:hover":{background:"linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%)"}},"aria-label":"\u53d1\u9001\u6d88\u606f",children:a?(0,$.jsx)(f.A,{size:22,color:"inherit"}):(0,$.jsx)(I.A,{sx:{fontSize:20}})})]})};var _=s(3464),R=s(33),D=s(8170),T=s(8587),L=s(8168),O=s(2004),U=s(8465),P=s(9254),N=s(9608),F=s(8463),z=s(1763),W=s(423);function J(e){return(0,W.Ay)("MuiDialogContentText",e)}(0,z.A)("MuiDialogContentText",["root"]);const B=["children","className"],H=(0,P.Ay)(p.A,{shouldForwardProp:e=>(0,N.A)(e)||"classes"===e,name:"MuiDialogContentText",slot:"Root",overridesResolver:(e,t)=>t.root})({}),V=a.forwardRef((function(e,t){const s=(0,F.b)({props:e,name:"MuiDialogContentText"}),{className:a}=s,n=(0,T.A)(s,B),o=(e=>{const{classes:t}=e,s=(0,U.A)({root:["root"]},J,t);return(0,L.A)({},t,s)})(n);return(0,$.jsx)(H,(0,L.A)({component:"p",variant:"body1",color:"text.secondary",ref:t,ownerState:n,className:(0,O.A)(o.root,a)},s,{classes:o}))}));var K=s(9739);const q=e=>{let{open:t,onClose:s,onConfirmDelete:a}=e;return(0,$.jsxs)(_.A,{open:t,onClose:s,disableEnforceFocus:!0,disableRestoreFocus:!0,"aria-labelledby":"alert-dialog-title","aria-describedby":"alert-dialog-description",children:[(0,$.jsx)(R.A,{id:"alert-dialog-title",children:"\u786e\u8ba4\u5220\u9664"}),(0,$.jsx)(D.A,{children:(0,$.jsx)(V,{id:"alert-dialog-description",children:"\u4f60\u786e\u5b9a\u8981\u5220\u9664\u8fd9\u4e2a\u804a\u5929\u8bb0\u5f55\u5417\uff1f\u6b64\u64cd\u4f5c\u65e0\u6cd5\u64a4\u9500\u3002"})}),(0,$.jsxs)(K.A,{children:[(0,$.jsx)(C.A,{onClick:s,children:"\u53d6\u6d88"}),(0,$.jsx)(C.A,{onClick:a,color:"error",autoFocus:!0,children:"\u5220\u9664"})]})]})},Z=(0,a.forwardRef)(((e,t)=>{let{flowId:s,onNodeSelect:o,onActiveChatChange:f,onChatInteractionStateChange:p}=e;const[C,v]=(0,a.useState)(""),x=(0,a.useRef)(null),{chatList:S,activeChatId:y,messages:w,isLoadingList:b,isLoadingChat:E,error:A,setChatList:k,setActiveChatId:I,setMessages:_,setError:R,fetchChatList:D,fetchChatMessages:T,initializeData:L,clearData:O}=(()=>{const[e,t]=(0,a.useState)([]),[s,n]=(0,a.useState)(null),[o,r]=(0,a.useState)([]),[c,d]=(0,a.useState)(!1),[u,g]=(0,a.useState)(!1),[h,f]=(0,a.useState)(null),p=(0,a.useCallback)((async e=>{d(!0),f(null);try{console.log("Fetching chat list for flow:",e);const s=await l(e,0,100);return t(s||[]),console.log("Chat list fetched:",s),s||[]}catch(s){return console.error("Failed to load chat list:",s),f(`\u52a0\u8f7d\u804a\u5929\u5217\u8868\u5931\u8d25: ${s.message}`),t([]),[]}finally{d(!1)}}),[]),C=(0,a.useCallback)((async e=>{if(!e)return r([]),void g(!1);g(!0),f(null);try{var t,s;console.log("Fetching messages for chat:",e);const a=await i(e),n=((null===(t=a.chat_data)||void 0===t?void 0:t.messages)||[]).map((e=>({...e,type:"text"})));r(n),console.log("Messages fetched:",null===(s=a.chat_data)||void 0===s?void 0:s.messages)}catch(a){console.error(`Failed to load messages for chat ${e}:`,a),f(`\u52a0\u8f7d\u804a\u5929\u5185\u5bb9\u5931\u8d25: ${a.message}`),r([])}finally{g(!1)}}),[]),v=(0,a.useCallback)((async e=>{try{var t;const s=await(0,m.jg)(e);return null!==(t=null===s||void 0===s?void 0:s.chatId)&&void 0!==t?t:null}catch(s){return console.error("Failed to get last chat ID:",s),null}}),[]),x=(0,a.useCallback)((async e=>{if(e){console.log("Flow ID changed:",e),t([]),n(null),r([]),f(null),d(!0),g(!0);try{const t=await v(e);console.log("Last interacted chat ID:",t),await p(e),n(t),t?await C(t):g(!1)}catch(s){console.error("Failed during initial load sequence:",s),f(`\u521d\u59cb\u5316\u804a\u5929\u754c\u9762\u5931\u8d25: ${s.message}`),d(!1),g(!1)}}}),[p,C,v]),S=(0,a.useCallback)((()=>{t([]),n(null),r([]),f(null),d(!1),g(!1)}),[]);return{chatList:e,activeChatId:s,messages:o,isLoadingList:c,isLoadingChat:u,error:h,setChatList:t,setActiveChatId:n,setMessages:r,setError:f,fetchChatList:p,fetchChatMessages:C,initializeData:x,clearData:S}})(),{streamingAssistantMsgIdRef:U,closeEventSourceRef:P,createSendMessageHandler:N,createErrorHandler:F,createCloseHandler:z,closeActiveConnection:W}=(()=>{const e=(0,a.useRef)(null),t=(0,a.useRef)(null),s=(0,a.useCallback)(((t,s,a)=>n=>{console.log("Received SSE Event:",JSON.stringify(n));let o=null;"stream_end"===n.type&&(o=e.current),t((t=>{const r=[...t],i=r.findIndex((t=>t.timestamp===e.current&&"text"===t.type));switch(n.type){case"user_message_saved":const{client_message_id:t,server_message_timestamp:l}=n.data,c=r.findIndex((e=>e.timestamp===t&&"user"===e.role));-1!==c&&(r[c]={...r[c],timestamp:l});break;case"token":const d=n.data,u=e.current,g=r.findIndex((e=>e.timestamp===u&&"text"===e.type));if(-1!==g)r[g]={...r[g],content:r[g].content+d,isStreaming:!0};else if(d){const t=u||`assistant-${Date.now()}`;u||(e.current=t),r.push({role:"assistant",content:d,timestamp:t,type:"text",isStreaming:!0})}break;case"tool_start":const h={role:"assistant",content:"",timestamp:`tool-${n.data.name}-${Date.now()}`,type:"tool_status",toolName:n.data.name,toolInput:n.data.input,toolStatus:"running",isStreaming:!1};-1!==i?r.splice(i,0,h):r.push(h);break;case"tool_end":const m=r.findLastIndex((e=>"tool_status"===e.type&&e.toolName===n.data.name&&"running"===e.toolStatus));-1!==m&&(r[m]={...r[m],toolStatus:"completed",toolOutputSummary:n.data.output_summary});break;case"stream_end":const f=r.findIndex((e=>e.timestamp===o));if(-1!==f)r[f]={...r[f],isStreaming:!1};else{const e=r.findLastIndex((e=>"assistant"===e.role&&!0===e.isStreaming));-1!==e&&(r[e]={...r[e],isStreaming:!1})}break;case"error":const p=`\u9519\u8bef: ${n.data.message||"\u672a\u77e5\u9519\u8bef"}`;s(p),a(!1);break;case"ping":console.log("Received ping event from server.");break;default:console.warn("Received unknown event type:",n)}return r}))}),[]),n=(0,a.useCallback)(((e,t)=>s=>{console.error("Chat API Error:",s),e(s.message||"\u8fde\u63a5\u9519\u8bef"),t(!1)}),[]),o=(0,a.useCallback)((s=>()=>{console.log("Chat EventSource closed."),s(!1),e.current=null,t.current=null}),[]),r=(0,a.useCallback)((()=>{t.current&&(console.log("Closing active EventSource connection."),t.current(),t.current=null)}),[]);return{streamingAssistantMsgIdRef:e,closeEventSourceRef:t,createSendMessageHandler:s,createErrorHandler:n,createCloseHandler:o,closeActiveConnection:r}})(),{isSending:J,isCreatingChat:B,isDeletingChatId:H,isRenamingChatId:V,renameInputValue:K,showDeleteConfirm:Z,chatToDelete:Y,editingMessageTimestamp:G,editingMessageContent:Q,setRenameInputValue:X,setEditingMessageContent:ee,handleCreateNewChat:te,handleSelectChat:se,handleSendMessage:ae,handleStartRename:ne,handleCancelRename:oe,handleConfirmRename:re,handleDeleteChat:ie,confirmDeleteChat:le,cancelDeleteChat:ce,handleStartEditMessage:de,handleCancelEditMessage:ue,handleConfirmEditMessage:ge}=(e=>{let{flowId:t,activeChatId:s,chatList:n,messages:o,setChatList:i,setActiveChatId:l,setMessages:m,setError:f,fetchChatList:p,fetchChatMessages:C,streamingAssistantMsgIdRef:v,closeEventSourceRef:x,closeActiveConnection:S}=e;const[y,w]=(0,a.useState)(!1),[b,E]=(0,a.useState)(!1),[A,$]=(0,a.useState)(null),[k,M]=(0,a.useState)(null),[I,j]=(0,a.useState)(""),[_,R]=(0,a.useState)(!1),[D,T]=(0,a.useState)(null),[L,O]=(0,a.useState)(null),[U,P]=(0,a.useState)(""),N=(0,a.useCallback)((async()=>{if(t&&!b){S(),E(!0),f(null);try{console.log("Creating new chat for flow:",t);const e=await r(t);console.log("New chat created:",e),await p(t),l(e.id),O(null),P("")}catch(e){console.error("Failed to create new chat:",e),f(`\u521b\u5efa\u65b0\u804a\u5929\u5931\u8d25: ${e.message}`)}finally{E(!1)}}}),[t,b,S,f,p,l]),F=(0,a.useCallback)((e=>{e!==s&&(S(),console.log("Selecting chat:",e),l(e),M(null),O(null),P(""),t&&u(t,e).then((()=>console.log(`Successfully updated last active chat to ${e} for flow ${t}`))).catch((e=>console.error(`Error updating last active chat for flow ${t}:`,e))))}),[s,S,l,M,t]),z=(0,a.useCallback)(((e,t,a,n)=>{if(!e.trim()||!s||y)return;S(),w(!0),f(null);const o={role:"user",content:e,timestamp:`user-${Date.now()}`,type:"text"};m((e=>[...e,o]));const r=`assistant-${Date.now()}`;v.current=r;const i={role:"assistant",content:"",timestamp:r,type:"text",isStreaming:!0};m((e=>[...e,i])),s?x.current=h(s,e,t(m,f,w),a(f,w),n(w),"user",o.timestamp):(console.error("Cannot send message, activeChatId is null"),f("\u65e0\u6cd5\u53d1\u9001\u6d88\u606f\uff0c\u6ca1\u6709\u6d3b\u52a8\u7684\u804a\u5929\u3002"),w(!1),m((e=>e.filter((e=>e.timestamp!==r)))))}),[s,y,S,f,m,v,x]),W=(0,a.useCallback)(((e,t)=>{M(e),j(t)}),[]),J=(0,a.useCallback)((()=>{M(null),j("")}),[]),B=(0,a.useCallback)((async e=>{var s,a;if(!I.trim()||I.trim()===(null===(s=n.find((t=>t.id===e)))||void 0===s?void 0:s.name))return void J();const o=null===(a=n.find((t=>t.id===e)))||void 0===a?void 0:a.name;try{console.log(`Renaming chat ${e} to: ${I.trim()}`),i((t=>t.map((t=>t.id===e?{...t,name:I.trim()}:t)))),await c(e,{name:I.trim()}),t&&await p(t),console.log("Chat renamed successfully"),J()}catch(r){console.error(`Failed to rename chat ${e}:`,r),f(`\u91cd\u547d\u540d\u5931\u8d25: ${r.message}`),i((t=>t.map((t=>t.id===e?{...t,name:o||t.name}:t))))}}),[I,n,J,i,p,t,f]),H=(0,a.useCallback)((e=>{T(e),R(!0)}),[]),V=(0,a.useCallback)((async()=>{if(D&&t){R(!1),$(D),f(null);try{console.log(`Deleting chat ${D}`),await d(D),console.log("Chat deleted successfully"),s===D&&(l(null),m([])),await p(t)}catch(e){console.error(`Failed to delete chat ${D}:`,e),f(`\u5220\u9664\u804a\u5929\u5931\u8d25: ${e.message}`)}finally{$(null),T(null)}}}),[D,t,f,s,l,m,p]),K=(0,a.useCallback)((()=>{R(!1),T(null)}),[]),q=(0,a.useCallback)((e=>{"user"===e.role&&e.timestamp&&(S(),v.current=null,m((e=>e.filter((e=>!(e.isStreaming&&"assistant"===e.role))))),O(e.timestamp),P(e.content),setTimeout((()=>{const t=document.getElementById(`message-${e.timestamp}`);t&&t.scrollIntoView({behavior:"auto",block:"nearest"})}),0))}),[S,v,m]),Z=(0,a.useCallback)((()=>{O(null),P("")}),[]),Y=(0,a.useCallback)((async(e,a,n)=>{const o=L;if(!o||!s||!t)return void console.warn("handleConfirmEditMessage: Missing required IDs or content.");if(o.startsWith("user-")&&!o.startsWith("user-edited-"))return void f("\u6d88\u606f\u5c1a\u672a\u5b8c\u5168\u4fdd\u5b58\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002");S(),w(!0),f(null);const r=U;m((e=>{const t=e.findIndex((e=>e.timestamp===o));if(-1===t)return e;const s=e.slice(0,t);return s.push({role:"user",content:r,timestamp:`user-edited-${Date.now()}`,type:"text"}),s})),O(null),P("");const i=`assistant-after-edit-${Date.now()}`;v.current=i;const l={role:"assistant",content:"",timestamp:i,type:"text",isStreaming:!0};m((e=>[...e,l])),s&&(x.current=g(s,o,r,e(m,f,w),a(f,w),n(w)))}),[L,s,t,U,S,f,m,v,x]);return{isSending:y,isCreatingChat:b,isDeletingChatId:A,isRenamingChatId:k,renameInputValue:I,showDeleteConfirm:_,chatToDelete:D,editingMessageTimestamp:L,editingMessageContent:U,setIsSending:w,setRenameInputValue:j,setEditingMessageContent:P,handleCreateNewChat:N,handleSelectChat:F,handleSendMessage:z,handleStartRename:W,handleCancelRename:J,handleConfirmRename:B,handleDeleteChat:H,confirmDeleteChat:V,cancelDeleteChat:K,handleStartEditMessage:q,handleCancelEditMessage:Z,handleConfirmEditMessage:Y}})({flowId:s,activeChatId:y,chatList:S,messages:w,setChatList:k,setActiveChatId:I,setMessages:_,setError:R,fetchChatList:D,fetchChatMessages:T,streamingAssistantMsgIdRef:U,closeEventSourceRef:P,closeActiveConnection:W});(0,a.useEffect)((()=>{s?L(s):O()}),[s,L,O]),(0,a.useEffect)((()=>{y?T(y):_([])}),[y,T,_]),(0,a.useEffect)((()=>{if(f)if(y){const e=S.find((e=>e.id===y));f(e?e.name:null)}else f(null)}),[y,S,f]);const he=(0,a.useMemo)((()=>({isCreatingChat:B,canDownload:!!y&&w.length>0})),[B,y,w.length]);(0,a.useEffect)((()=>{p&&p(he)}),[he,p]),(0,a.useEffect)((()=>{var e;null===(e=x.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[w]),(0,a.useEffect)((()=>()=>{W()}),[W]);const me=(0,a.useCallback)((()=>{C.trim()&&y&&!J&&!E&&(ae(C,N,F,z),v(""))}),[C,y,J,E,ae,N,F,z]),fe=(0,a.useCallback)((e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),me())}),[me]),pe=(0,a.useCallback)((()=>{if(!y||0===w.length)return void R("\u6ca1\u6709\u6d3b\u52a8\u7684\u804a\u5929\u6216\u6d88\u606f\u53ef\u4f9b\u4e0b\u8f7d");const e=S.find((e=>e.id===y)),t=(null===e||void 0===e?void 0:e.name)||`chat-${y}`;try{const e=((e,t)=>{let s=`# Chat History: ${t}\n\n`;return e.forEach((e=>{const t=e.role.charAt(0).toUpperCase()+e.role.slice(1);s+=`## ${t}\n\n`,"tool_status"===e.type?(s+=`**[Tool: ${e.toolName||"Unknown"}]** - Status: ${e.toolStatus}`,e.toolOutputSummary&&(s+=`\nOutput: ${e.toolOutputSummary}`),e.toolErrorMessage&&(s+=`\nError: ${e.toolErrorMessage}`),s+="\n\n"):s+=`${e.content}\n\n`,s+="---\n\n"})),s})(w,t);((e,t)=>{const s=new Blob([e],{type:"text/markdown"}),a=URL.createObjectURL(s),n=document.createElement("a");n.href=a,n.download=t.endsWith(".md")?t:`${t}.md`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)})(e,`${t}.md`),R(null)}catch(s){console.error("Failed to download chat:",s),R(`\u4e0b\u8f7d\u804a\u5929\u8bb0\u5f55\u5931\u8d25: ${s.message}`)}}),[y,w,S,R]),Ce=!!y,ve=!Ce||J||E||b||B;return(0,a.useImperativeHandle)(t,(()=>({createNewChat:te,downloadActiveChat:pe,getChatList:async()=>s?await D(s):null,renameChat:async(e,t)=>{t.trim()?console.log(`[Imperative] Renaming chat ${e} to: ${t.trim()}`):console.warn("Rename skipped: new name is empty.")},deleteChat:e=>{ie(e)},selectChat:e=>{se(e)}})),[te,pe,D,s,ie,se]),(0,$.jsxs)(n.A,{sx:{height:"100%",display:"flex",flexDirection:"row",padding:1,gap:1,overflow:"hidden"},children:[(0,$.jsxs)(n.A,{sx:{flex:1,display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[(0,$.jsx)(M,{messages:w,activeChatId:y,isLoadingChat:E,editingMessageTimestamp:G,editingMessageContent:Q,isSending:J,onNodeSelect:o,onStartEditMessage:de,onEditingContentChange:ee,onConfirmEditMessage:()=>ge(N,F,z),onCancelEditMessage:ue}),(0,$.jsx)(j,{inputMessage:C,inputDisabled:ve,isSending:J,editingMessageTimestamp:G,onInputChange:v,onSendMessage:me,onKeyPress:fe,hasActiveChat:Ce})]}),(0,$.jsx)(q,{open:Z,onClose:ce,onConfirmDelete:le})]})}))}}]);