### **LangGraph 再利用性ガイド**

---

#### **1. はじめに**

システムのコア設計思想は、自然言語のタスクを分解し、決定論的なコードを生成するマルチエージェントフレームワークです。このドキュメントの目的は、このフレームワークを他のドメインに再利用する方法について、開発者に明確なガイドラインを提供することです。

---

#### **2. コア再利用可能アーキテクチャ**

このシステムの中心には、特定のビジネスドメインに依存しない、再利用可能なコアコンポーネントが存在します。

- **メインワークフローグラフ (Main Workflow Graph):**
  入力 → 分解 → レビュー → 生成 → 出力という、システム全体のステートマシンフロー。
- **状態管理 (State Management):**
  すべてのノードを通過するデータバスとして機能する `AgentState` の概念。
- **ヒューマンインザループ・ノード (Human-in-the-Loop Node):**
  汎用的なレビューおよび校正ステップとして機能する `SAS_REVIEW_AND_REFINE` の設計思想。
- **スキーマ駆動の入力解析 (Schema-Driven Input Parsing):**
  `user_input_to_task_list` ノードにおける、Pydantic モデルを使用して LLM の出力を制約する方法論。

---

#### **3. ドメイン固有コンポーネント**

現在のシステムで「ロボット制御」ドメインに強く結合しており、新しいドメインに適応させる際に**置換または修正**が必要な部分です。

- **ナレッジベース (Knowledge Base):**
  `database/node_database/` にある XML ノードテンプレート。
- **プロンプトエンジニアリング (Prompt Engineering):**
  `database/prompt_database/` にある、ロボット分野の例や用語を含むプロンプト。
- **最終コードジェネレータ (Final Code Generator):**
  XML 形式に強く関連するロジックを持つ `generate_individual_xmls` ノード。

---

#### **4. 新ドメイン（産業用画像処理）への適応手順**

以下に、フレームワークを新しいドメインに適応させるためのステップバイステップガイドを示します。

- **ステップ 1：新しい「アトミック能力」ナレッジベースの定義**
  画像処理用の新しい「ノードデータベース」を作成する必要があります。例えば、`apply_gaussian_blur.py` や `detect_edges.py` といったアトミックな操作の関数シグネチャや JSON 記述を定義します。

- **ステップ 2：プロンプトの更新**
  `prompt_database` 内のプロンプトを修正し、例を「ロボットアームを動かす」から「画像を処理する」に置き換え、LLM に新しい利用可能なツールセット（ステップ 1 で定義したアトミック能力）を通知する方法を説明します。

- **ステップ 3：AgentState の汎用化**
  `RobotFlowAgentState` をより汎用的な `AgentState` にリファクタリングし、ロボット関連の特定のフィールドを削除することを推奨します。

- **ステップ 4：コード生成ノードの置換**
  `generate_individual_xmls` を、例えば `generate_image_processing_script` という名前の新しいノードで置き換える方法を詳述します。この新しいノードは、Python コード（例：OpenCV や Pillow ライブラリを使用）の生成を担当します。

- **ステップ 5：検証スキーマの調整**
  画像処理タスクのパラメータや構造に合わせて、`user_input_to_task_list` で使用される Pydantic モデルを修正する必要があることを説明します。

---

#### **5. インターフェース定義**

適応後のシステムのインターフェースを要約します。入力は引き続き自然言語記述ですが、出力はターゲットとなるコードファイル（例：`.py` スクリプト）に変わります。
