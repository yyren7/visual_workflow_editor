# Flow å¤åˆ¶åŠŸèƒ½æ”¹è¿›æ€»ç»“

## é—®é¢˜èƒŒæ™¯

ç”¨æˆ·åé¦ˆåœ¨ flow é€‰æ‹©ç•Œé¢çš„å¤åˆ¶åŠŸèƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. åªå¤åˆ¶äº†åŸºæœ¬çš„`flow_data`ï¼Œæ²¡æœ‰å¤åˆ¶ LangGraph æŒä¹…åŒ–çŠ¶æ€
2. å¤åˆ¶çš„ flow ä¸­æ‰€æœ‰ ID éƒ½æ²¡æœ‰é‡æ–°ç”Ÿæˆï¼Œå¯èƒ½å¯¼è‡´å†²çª
3. ç¼ºå°‘å¯¹`sas_state`ï¼ˆLangGraph çŠ¶æ€ï¼‰çš„å®Œæ•´å¤åˆ¶

## è§£å†³æ–¹æ¡ˆ

### ğŸ¯ æ ¸å¿ƒæ”¹è¿›

æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ flow å¤åˆ¶è§£å†³æ–¹æ¡ˆï¼ŒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

#### 1. å‰ç«¯æ”¹è¿› (`frontend/src/api/flowApi.ts`)

**æ–°å¢åŠŸèƒ½ï¼š**

- âœ… **ID é‡æ–°ç”Ÿæˆç³»ç»Ÿ**ï¼šä¸ºæ‰€æœ‰èŠ‚ç‚¹å’Œè¾¹ç”Ÿæˆæ–°çš„å”¯ä¸€ ID
- âœ… **æ·±åº¦å¤åˆ¶æœºåˆ¶**ï¼šé€’å½’å¤åˆ¶æ•´ä¸ª flow_data ç»“æ„
- âœ… **æ™ºèƒ½ ID æ˜ å°„**ï¼šç»´æŠ¤æ—§ ID åˆ°æ–° ID çš„æ˜ å°„å…³ç³»
- âœ… **sas_state å¤åˆ¶**ï¼šå®Œæ•´å¤åˆ¶ LangGraph æŒä¹…åŒ–çŠ¶æ€
- âœ… **è¿è¡Œæ—¶çŠ¶æ€æ¸…ç†**ï¼šè‡ªåŠ¨é‡ç½®ä¸åº”è¯¥å¤åˆ¶çš„çŠ¶æ€å­—æ®µ

**å…·ä½“å®ç°ï¼š**

```typescript
// ç”Ÿæˆæ–°çš„èŠ‚ç‚¹ID
const generateNewNodeId = (originalId: string): string => {
  const timestamp = Date.now();
  const parts = originalId.split("-");
  if (parts.length >= 2) {
    return `${parts[0]}-${timestamp}`;
  }
  return `node-${timestamp}`;
};

// æ·±åº¦å¤åˆ¶å¹¶é‡æ–°æ˜ å°„ID
const deepCopyAndRemapIds = (obj: any, idMapping: Map<string, string>): any => {
  // å¤„ç†èŠ‚ç‚¹IDã€nodeIdã€sourceã€targetç­‰æ‰€æœ‰IDå¼•ç”¨
};
```

#### 2. åç«¯æ”¹è¿› (`backend/app/schemas.py` å’Œ `backend/app/routers/flow.py`)

**Schema æ‰©å±•ï¼š**

```python
class FlowBase(BaseModel):
    name: Optional[str] = None
    flow_data: Optional[Dict[str, Any]] = None
    sas_state: Optional[Dict[str, Any]] = None  # æ–°å¢æ”¯æŒ
```

**API å¢å¼ºï¼š**

```python
async def create_flow(flow_data: schemas.FlowCreate, ...):
    # æ”¯æŒä¼ é€’sas_state
    if flow_data.sas_state:
        # éªŒè¯å¹¶ä½¿ç”¨ä¼ é€’çš„çŠ¶æ€
        validated_state = RobotFlowAgentState(**flow_data.sas_state)
        initial_state_dict = validated_state.model_dump(exclude_none=False)
    else:
        # ä½¿ç”¨é»˜è®¤çŠ¶æ€
        default_state_model = RobotFlowAgentState()
        initial_state_dict = default_state_model.model_dump(exclude_none=False)
```

### ğŸ”§ æŠ€æœ¯ç»†èŠ‚

#### ID é‡æ–°ç”Ÿæˆç­–ç•¥

| ç»„ä»¶ç±»å‹              | é‡æ–°ç”Ÿæˆè§„åˆ™                     |
| --------------------- | -------------------------------- |
| èŠ‚ç‚¹ ID               | ä¿ç•™ç±»å‹å‰ç¼€ + æ–°æ—¶é—´æˆ³          |
| è¾¹ ID                 | åŸºäºæ–°çš„æºå’Œç›®æ ‡èŠ‚ç‚¹ ID é‡æ–°ç”Ÿæˆ |
| nodeProperties.nodeId | æ˜ å°„åˆ°å¯¹åº”çš„æ–°èŠ‚ç‚¹ ID            |
| è¾¹çš„ source/target    | æ˜ å°„åˆ°æ–°çš„èŠ‚ç‚¹ ID                |

#### çŠ¶æ€æ¸…ç†ç­–ç•¥

**é‡ç½®çš„å­—æ®µï¼ˆè¿è¡Œæ—¶çŠ¶æ€ï¼‰ï¼š**

- `current_user_request` â†’ `null`
- `dialog_state` â†’ `'initial'`
- `messages` â†’ `[]`
- `task_list_accepted` â†’ `false`
- `module_steps_accepted` â†’ `false`
- `revision_iteration` â†’ `0`
- `error_message` â†’ `null`
- `is_error` â†’ `false`
- `subgraph_completion_status` â†’ `null`

**ä¿ç•™çš„å­—æ®µï¼ˆé…ç½®çŠ¶æ€ï¼‰ï¼š**

- è¯­è¨€è®¾ç½®
- é…ç½®å‚æ•°
- éè¿è¡Œæ—¶çš„ä¸šåŠ¡æ•°æ®

#### é”™è¯¯å¤„ç†æœºåˆ¶

1. **çŠ¶æ€éªŒè¯**ï¼šä½¿ç”¨`RobotFlowAgentState`æ¨¡å‹éªŒè¯ä¼ é€’çš„çŠ¶æ€
2. **å›é€€æœºåˆ¶**ï¼šéªŒè¯å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨é»˜è®¤çŠ¶æ€
3. **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•å¤åˆ¶è¿‡ç¨‹ä¸­çš„æ¯ä¸ªæ­¥éª¤
4. **äº‹åŠ¡å®‰å…¨**ï¼šç¡®ä¿å¤åˆ¶å¤±è´¥æ—¶ä¸å½±å“åŸå§‹ flow

### ğŸ“Š å¤åˆ¶æµç¨‹å›¾

```mermaid
flowchart TD
    A[ç”¨æˆ·ç‚¹å‡»å¤åˆ¶] --> B[è·å–åŸå§‹flowæ•°æ®]
    B --> C[è§£æflow_data]
    C --> D[åˆ›å»ºIDæ˜ å°„è¡¨]
    D --> E[ä¸ºæ‰€æœ‰èŠ‚ç‚¹ç”Ÿæˆæ–°ID]
    E --> F[æ·±åº¦å¤åˆ¶å¹¶é‡æ˜ å°„ID]
    F --> G[é‡æ–°ç”Ÿæˆè¾¹ID]
    G --> H[å¤åˆ¶å¹¶æ¸…ç†sas_state]
    H --> I[åˆ›å»ºæ–°flow]
    I --> J[åˆå§‹åŒ–LangGraphçŠ¶æ€]
    J --> K[è¿”å›å¤åˆ¶çš„flow]
```

### ğŸ§ª éªŒè¯è¦ç‚¹

#### å‰ç«¯éªŒè¯

1. **ç½‘ç»œè¯·æ±‚æ£€æŸ¥**ï¼šcreateFlow è¯·æ±‚åŒ…å«å®Œæ•´çš„ sas_state
2. **ID å”¯ä¸€æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹å’Œè¾¹ ID éƒ½æ˜¯æ–°ç”Ÿæˆçš„
3. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šå¤åˆ¶çš„ flow æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

#### åç«¯éªŒè¯

1. **çŠ¶æ€åˆå§‹åŒ–**ï¼šLangGraph çŠ¶æ€æ­£ç¡®åˆå§‹åŒ–
2. **æ•°æ®å®Œæ•´æ€§**ï¼šæ‰€æœ‰å¿…è¦å­—æ®µéƒ½è¢«æ­£ç¡®å¤„ç†
3. **é”™è¯¯å¤„ç†**ï¼šå¼‚å¸¸æƒ…å†µæœ‰é€‚å½“çš„å›é€€æœºåˆ¶

### ğŸš€ ä½¿ç”¨æ–¹æ³•

1. **å¯åŠ¨æœåŠ¡**ï¼š

   ```bash
   ./start-dev.sh logs
   ```

2. **æµ‹è¯•å¤åˆ¶**ï¼š

   - åˆ›å»ºåŒ…å«èŠ‚ç‚¹çš„ flow
   - ä½¿ç”¨ LangGraph åŠŸèƒ½ç”ŸæˆçŠ¶æ€
   - ç‚¹å‡»å¤åˆ¶æŒ‰é’®
   - éªŒè¯å¤åˆ¶ç»“æœ

3. **éªŒè¯æ¸…å•**ï¼š
   - [ ] æ–° flow æœ‰ç‹¬ç«‹çš„ ID ä½“ç³»
   - [ ] LangGraph çŠ¶æ€è¢«æ­£ç¡®å¤åˆ¶
   - [ ] è¿è¡Œæ—¶çŠ¶æ€è¢«é‡ç½®
   - [ ] åŸå§‹ flow ä¸å—å½±å“

### ğŸ“ æ¶‰åŠæ–‡ä»¶

| æ–‡ä»¶                          | ä¿®æ”¹å†…å®¹                                                |
| ----------------------------- | ------------------------------------------------------- |
| `frontend/src/api/flowApi.ts` | å®Œå…¨é‡å†™ duplicateFlow å‡½æ•°ï¼Œæ·»åŠ  ID ç”Ÿæˆå’ŒçŠ¶æ€å¤„ç†é€»è¾‘ |
| `backend/app/schemas.py`      | æ·»åŠ  sas_state å­—æ®µåˆ° FlowBase å’Œ FlowCreate            |
| `backend/app/routers/flow.py` | ä¿®æ”¹ create_flow API æ”¯æŒ sas_state å¤„ç†                |
| `test_flow_duplication.md`    | æ–°å¢æµ‹è¯•æŒ‡å—æ–‡æ¡£                                        |

### ğŸ‰ æ”¹è¿›æ•ˆæœ

**ä¹‹å‰**ï¼š

- âŒ åªå¤åˆ¶ flow_data
- âŒ ID å†²çªé£é™©
- âŒ LangGraph çŠ¶æ€ä¸¢å¤±
- âŒ åŠŸèƒ½ä¸å®Œæ•´

**ç°åœ¨**ï¼š

- âœ… å®Œæ•´å¤åˆ¶æ‰€æœ‰æ•°æ®
- âœ… ç‹¬ç«‹çš„ ID ä½“ç³»
- âœ… LangGraph çŠ¶æ€å®Œæ•´ä¿ç•™
- âœ… æ™ºèƒ½çŠ¶æ€é‡ç½®
- âœ… åŠŸèƒ½å®Œå…¨ç‹¬ç«‹

### ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¯¹å¤§å‹ flow çš„å¤åˆ¶è¿›è¡Œä¼˜åŒ–
2. **ID ç­–ç•¥**ï¼šè€ƒè™‘ä½¿ç”¨ UUID æ›¿ä»£æ—¶é—´æˆ³
3. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒå¤šä¸ª flow çš„æ‰¹é‡å¤åˆ¶
4. **æ¨¡æ¿åŠŸèƒ½**ï¼šå°†å¤åˆ¶æ‰©å±•ä¸ºæ¨¡æ¿ä¿å­˜åŠŸèƒ½

---

> **æ€»ç»“**ï¼šè¿™æ¬¡æ”¹è¿›è§£å†³äº† flow å¤åˆ¶åŠŸèƒ½çš„æ ¸å¿ƒé—®é¢˜ï¼Œå®ç°äº†çœŸæ­£æ„ä¹‰ä¸Šçš„"æ·±åº¦å¤åˆ¶"ï¼Œç¡®ä¿å¤åˆ¶çš„ flow åœ¨æ‰€æœ‰æ–¹é¢éƒ½ä¸åŸå§‹ flow å®Œå…¨ç‹¬ç«‹ï¼ŒåŒæ—¶ä¿æŒäº†å®Œæ•´çš„åŠŸèƒ½æ€§ã€‚
