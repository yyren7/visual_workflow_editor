sequenceDiagram
    %% ğŸ¨ UNIFIED STYLE VERSION / çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ç‰ˆ
    %% SAS LangGraph Frontend-Backend Sequence Interaction Diagram
    %% SAS LangGraph ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç›¸äº’ä½œç”¨å›³
    %% File: sas_sequence_interaction_en_jp.mermaid
    
    %%{init: {
        'theme': 'base',
        'themeVariables': {
            'primaryColor': '#2196F3',
            'primaryTextColor': '#FFFFFF',
            'primaryBorderColor': '#1976D2',
            'lineColor': '#424242',
            'sectionBkgColor': '#F5F5F5',
            'altSectionBkgColor': '#E3F2FD',
            'background': '#FFFFFF',
            'secondaryTextColor': '#212121',
            'tertiaryTextColor': '#FFFFFF',
            'sequenceNumberColor': '#FFFFFF',
            'signalColor': '#1976D2',
            'signalTextColor': '#212121',
            'labelBoxBkgColor': '#2196F3',
            'labelBoxBorderColor': '#0D47A1',
            'labelTextColor': '#FFFFFF',
            'loopTextColor': '#212121',
            'noteBorderColor': '#FF9800',
            'noteBkgColor': '#FFF8E1',
            'noteTextColor': '#E65100',
            'activationBorderColor': '#4CAF50',
            'activationBkgColor': '#C8E6C9'
        }
    }}%%
    
    participant User as User<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as LangGraphInputNode<br/>å…¥åŠ›ãƒãƒ¼ãƒ‰
    participant Hook as useAgentStateSync<br/>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçŠ¶æ…‹åŒæœŸ
    participant Redux as Redux Store<br/>çŠ¶æ…‹ã‚¹ãƒˆã‚¢
    participant API as FastAPI Server<br/>APIã‚µãƒ¼ãƒãƒ¼
    participant LG as LangGraph Engine<br/>LangGraphã‚¨ãƒ³ã‚¸ãƒ³
    participant LLM as Gemini LLM<br/>Geminiè¨€èªãƒ¢ãƒ‡ãƒ«
    participant DB as PostgreSQL<br/>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    participant SSE as SSE Stream<br/>SSEã‚¹ãƒˆãƒªãƒ¼ãƒ 
    
    %% User Input Processing Flow / ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å‡¦ç†ãƒ•ãƒ­ãƒ¼
    User->>UI: Input task description<br/>ã‚¿ã‚¹ã‚¯èª¬æ˜ã‚’å…¥åŠ›
    UI->>Hook: updateUserInput(content)<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›æ›´æ–°
    Hook->>Redux: updateAgentState({current_user_request})<br/>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçŠ¶æ…‹æ›´æ–°
    Hook->>API: POST /sas/{chat_id}/events<br/>POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
    Note over API: Create async task<br/>éåŒæœŸã‚¿ã‚¹ã‚¯ä½œæˆ
    API->>Hook: Return SSE stream connection<br/>SSEã‚¹ãƒˆãƒªãƒ¼ãƒ æ¥ç¶šã‚’è¿”ã™
    
    %% LangGraph Processing Flow / LangGraphå‡¦ç†ãƒ•ãƒ­ãƒ¼
    API->>LG: ainvoke(graph_input, config)<br/>ã‚°ãƒ©ãƒ•å®Ÿè¡Œé–‹å§‹
    activate LG
    
    LG->>LG: initialize_state_node<br/>çŠ¶æ…‹åˆæœŸåŒ–ãƒãƒ¼ãƒ‰
    LG->>DB: Save initial state<br/>åˆæœŸçŠ¶æ…‹ä¿å­˜
    
    LG->>LG: user_input_to_task_list_node<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã¸
    LG->>LLM: Generate task list<br/>ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆç”Ÿæˆ
    LLM->>LG: Return JSON tasks<br/>JSONã‚¿ã‚¹ã‚¯ã‚’è¿”ã™
    
    %% SSE Event Stream / SSEã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ 
    LG-->>SSE: Send token events<br/>ãƒˆãƒ¼ã‚¯ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
    SSE-->>UI: Display streaming text<br/>ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
    
    LG->>DB: Save task list state<br/>ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆçŠ¶æ…‹ä¿å­˜
    LG-->>SSE: agent_state_updated<br/>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçŠ¶æ…‹æ›´æ–°
    SSE-->>Hook: Receive state update<br/>çŠ¶æ…‹æ›´æ–°å—ä¿¡
    Hook->>Redux: Update agent_state<br/>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçŠ¶æ…‹æ›´æ–°
    Redux->>UI: Re-render<br/>å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    
    %% User Review Process / ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹
    Note over UI: Display task list<br/>Wait for user review<br/>ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…æ©Ÿ
    UI->>UI: dialog_state = "sas_awaiting_task_list_review"<br/>ãƒ€ã‚¤ã‚¢ãƒ­ã‚°çŠ¶æ…‹è¨­å®š
    
    alt User approves / ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èª
        User->>UI: Click "Approve Tasks"<br/>ã€Œã‚¿ã‚¹ã‚¯æ‰¿èªã€ã‚’ã‚¯ãƒªãƒƒã‚¯
        UI->>Hook: updateUserInput("accept_tasks")<br/>å—è«¾å…¥åŠ›æ›´æ–°
        Hook->>API: POST /sas/{chat_id}/events<br/>POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
        API->>LG: Continue processing<br/>å‡¦ç†ç¶šè¡Œ
        LG->>LG: review_and_refine_node<br/>ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ”¹è‰¯ãƒãƒ¼ãƒ‰
        LG->>LG: process_to_module_steps_node<br/>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—å‡¦ç†ãƒãƒ¼ãƒ‰
    else User modifies / ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿®æ­£
        User->>UI: Input modification feedback<br/>ä¿®æ­£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ›
        UI->>Hook: updateUserInput(feedback)<br/>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å…¥åŠ›æ›´æ–°
        Hook->>API: POST /sas/{chat_id}/events<br/>POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
        API->>LG: Reprocess<br/>å†å‡¦ç†
        LG->>LG: Return to task_list_node<br/>ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆãƒãƒ¼ãƒ‰ã«æˆ»ã‚‹
    end
    
    %% XML Generation Flow / XMLç”Ÿæˆãƒ•ãƒ­ãƒ¼
    LG->>LG: generate_individual_xmls<br/>å€‹åˆ¥XMLç”Ÿæˆ
    loop Each task / å„ã‚¿ã‚¹ã‚¯
        LG->>LLM: Generate XML<br/>XMLç”Ÿæˆ
        LLM->>LG: Return XML content<br/>XMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿”ã™
    end
    
    LG->>LG: sas_merge_xmls<br/>XMLãƒãƒ¼ã‚¸
    LG->>LG: sas_concatenate_xmls<br/>XMLé€£çµ
    LG->>DB: Save final state<br/>æœ€çµ‚çŠ¶æ…‹ä¿å­˜
    
    deactivate LG
    
    %% Completion Notification / å®Œäº†é€šçŸ¥
    LG-->>SSE: stream_end event<br/>ã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆ
    SSE-->>Hook: Stream ended<br/>ã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚äº†
    Hook->>Hook: Cleanup subscription<br/>è³¼èª­ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    UI->>UI: Display completion status<br/>å®Œäº†çŠ¶æ…‹è¡¨ç¤º
    
    Note over UI: dialog_state = "sas_step3_completed"<br/>Display XML file path<br/>ãƒ€ã‚¤ã‚¢ãƒ­ã‚°çŠ¶æ…‹ï¼šå®Œäº†<br/>XMLãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹è¡¨ç¤º 