flowchart LR
    %% ğŸ¨ UNIFIED STYLE VERSION / çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ç‰ˆ
    %% SAS LangGraph Data Flow Diagram / SAS LangGraph ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³  
    %% File: sas_data_flow_en_jp.mermaid
    
    %%{init: {
        'theme': 'default',
        'themeVariables': {
            'primaryColor': '#ffffff',
            'primaryTextColor': '#333333',
            'primaryBorderColor': '#2196F3',
            'lineColor': '#666666',
            'sectionBkgColor': '#f8f9fa',
            'background': '#ffffff',
            'secondaryTextColor': '#555555',
            'tertiaryTextColor': '#333333',
            'cScale0': '#E3F2FD',
            'cScale1': '#BBDEFB',
            'cScale2': '#90CAF9'
        }
    }}%%
    
    %% Enhanced Color Scheme / å¢å¼ºé…è‰²æ–¹æ¡ˆ
    classDef frontend fill:#E3F2FD,stroke:#2196F3,stroke-width:2px,color:#1565C0
    classDef backend fill:#FFF3E0,stroke:#FF9800,stroke-width:2px,color:#E65100
    classDef database fill:#F3E5F5,stroke:#9C27B0,stroke-width:2px,color:#7B1FA2
    classDef sse fill:#E8F5E8,stroke:#4CAF50,stroke-width:2px,color:#2E7D32
    classDef llm fill:#FCE4EC,stroke:#E91E63,stroke-width:2px,color:#C2185B
    classDef subgraphStyle fill:#f8f9fa,stroke:#e0e0e0,stroke-width:1px
    
    %% Frontend Components / ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    subgraph Frontend["ğŸ–¥ï¸ Frontend (React)<br/>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (React)"]
        UI["LangGraphInputNode<br/>ğŸ“± User Interface<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹"]:::frontend
        Redux["Redux Store<br/>ğŸª State Management<br/>çŠ¶æ…‹ç®¡ç†"]:::frontend
        SSEClient["SSE Manager<br/>ğŸ“¡ Event Subscription<br/>ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­"]:::frontend
    end
    
    %% API Layer / API ãƒ¬ã‚¤ãƒ¤ãƒ¼
    subgraph API["ğŸŒ API Layer (FastAPI)<br/>API ãƒ¬ã‚¤ãƒ¤ãƒ¼ (FastAPI)"]
        Router["SAS Router<br/>ğŸ”€ /sas/{chat_id}/events<br/>SAS ãƒ«ãƒ¼ã‚¿ãƒ¼"]:::backend
        Broadcaster["Event Broadcaster<br/>ğŸ“¢ ã‚¤ãƒ™ãƒ³ãƒˆ ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ã‚¿ãƒ¼"]:::backend
        FlowAPI["Flow Router<br/>ğŸ”„ /flows/{flow_id}<br/>ãƒ•ãƒ­ãƒ¼ ãƒ«ãƒ¼ã‚¿ãƒ¼"]:::backend
    end
    
    %% LangGraph Processing Layer / LangGraph å‡¦ç†ãƒ¬ã‚¤ãƒ¤ãƒ¼
    subgraph LangGraph["âš™ï¸ LangGraph Engine<br/>LangGraph ã‚¨ãƒ³ã‚¸ãƒ³"]
        StateGraph["State Graph<br/>ğŸ“Š ã‚¹ãƒ†ãƒ¼ãƒˆ ã‚°ãƒ©ãƒ•"]:::backend
        Nodes["Processing Nodes<br/>ğŸ”§ (8 nodes)<br/>å‡¦ç†ãƒãƒ¼ãƒ‰ (8å€‹)"]:::backend
        Checkpointer["Checkpointer<br/>ğŸ’¾ State Persistence<br/>çŠ¶æ…‹æ°¸ç¶šåŒ–"]:::backend
    end
    
    %% LLM Service / LLM ã‚µãƒ¼ãƒ“ã‚¹
    subgraph LLM["ğŸ¤– AI Service<br/>AI ã‚µãƒ¼ãƒ“ã‚¹"]
        Gemini["Google Gemini<br/>ğŸ§  Language Model<br/>è¨€èªãƒ¢ãƒ‡ãƒ«"]:::llm
    end
    
    %% Data Storage / ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
    subgraph Storage["ğŸ’½ Data Storage<br/>ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸"]
        PostgreSQL["PostgreSQL<br/>ğŸ—„ï¸ Main Database<br/>ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹"]:::database
        FileSystem["File System<br/>ğŸ“ XML Files<br/>XMLãƒ•ã‚¡ã‚¤ãƒ«"]:::database
    end
    
    %% Data Flow / ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
    UI -->|"ğŸ‘¤ User Input<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›"| Redux
    Redux -->|"ğŸ“¤ POST Request<br/>POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ"| Router
    Router -->|"ğŸš€ Start Processing<br/>å‡¦ç†é–‹å§‹"| StateGraph
    
    StateGraph -->|"ğŸ”„ Call Nodes<br/>ãƒãƒ¼ãƒ‰å‘¼ã³å‡ºã—"| Nodes
    Nodes -->|"ğŸ¤– LLM Request<br/>LLMãƒªã‚¯ã‚¨ã‚¹ãƒˆ"| Gemini
    Gemini -->|"ğŸ’­ AI Response<br/>AIå¿œç­”"| Nodes
    
    Nodes -->|"ğŸ“ State Update<br/>çŠ¶æ…‹æ›´æ–°"| Checkpointer
    Checkpointer -->|"ğŸ’¾ Persistence<br/>æ°¸ç¶šåŒ–"| PostgreSQL
    
    Nodes -->|"ğŸ“„ Generate Files<br/>ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ"| FileSystem
    
    StateGraph -->|"ğŸ“Š Event Stream<br/>ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ "| Broadcaster
    Broadcaster -->|"âš¡ SSE Push<br/>SSEãƒ—ãƒƒã‚·ãƒ¥"| SSEClient
    SSEClient -->|"ğŸ”„ Update UI<br/>UIæ›´æ–°"| Redux
    Redux -->|"ğŸ¨ Render<br/>ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°"| UI
    
    FlowAPI -->|"â“ Query State<br/>çŠ¶æ…‹ç…§ä¼š"| PostgreSQL
    FlowAPI -->|"âš™ï¸ Manage Flow<br/>ãƒ•ãƒ­ãƒ¼ç®¡ç†"| StateGraph
    
    %% SSE Event Stream Details / SSE ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ è©³ç´°
    subgraph SSEEvents["ğŸ“¡ SSE Event Types<br/>SSE ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—"]
        direction TB
        E1["agent_state_updated<br/>ğŸ“Š ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆçŠ¶æ…‹æ›´æ–°"]:::sse
        E2["token (LLM Stream)<br/>ğŸ’¬ ãƒˆãƒ¼ã‚¯ãƒ³ (LLMã‚¹ãƒˆãƒªãƒ¼ãƒ )"]:::sse
        E3["tool_start/end<br/>ğŸ”§ ãƒ„ãƒ¼ãƒ«é–‹å§‹/çµ‚äº†"]:::sse
        E4["task_progress<br/>ğŸ“ˆ ã‚¿ã‚¹ã‚¯é€²æ—"]:::sse
        E5["stream_end<br/>âœ… ã‚¹ãƒˆãƒªãƒ¼ãƒ çµ‚äº†"]:::sse
    end
    
    Broadcaster -.->|"ğŸ“‹ Event Types<br/>ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—"| SSEEvents
    
    %% Apply styles to subgraphs
    Frontend:::subgraphStyle
    API:::subgraphStyle
    LangGraph:::subgraphStyle
    LLM:::subgraphStyle
    Storage:::subgraphStyle
    SSEEvents:::subgraphStyle 