graph TD
    %% ğŸ¨ UNIFIED STYLE VERSION / çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ç‰ˆ
    %% SAS LangGraph State Transition Diagram / SAS LangGraph çŠ¶æ…‹é·ç§»å›³
    %% File: sas_state_transition_en_jp.mermaid
    
    %%{init: {
        'theme': 'base',
        'themeVariables': {
            'primaryColor': '#2196F3',
            'primaryTextColor': '#FFFFFF',
            'primaryBorderColor': '#1976D2',
            'lineColor': '#424242',
            'sectionBkgColor': '#F5F5F5',
            'background': '#FFFFFF',
            'secondaryTextColor': '#212121',
            'tertiaryTextColor': '#FFFFFF'
        }
    }}%%
    
    %% Define unified node styles / çµ±ä¸€ãƒãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã®å®šç¾©
    classDef initNode fill:#4CAF50,stroke:#1B5E20,stroke-width:3px,color:#FFFFFF
    classDef processNode fill:#2196F3,stroke:#0D47A1,stroke-width:3px,color:#FFFFFF
    classDef reviewNode fill:#FF9800,stroke:#E65100,stroke-width:3px,color:#FFFFFF
    classDef errorNode fill:#F44336,stroke:#C62828,stroke-width:3px,color:#FFFFFF
    classDef endNode fill:#9C27B0,stroke:#4A148C,stroke-width:3px,color:#FFFFFF
    
    %% Define state nodes / çŠ¶æ…‹ãƒãƒ¼ãƒ‰ã®å®šç¾©
    START(("Start / é–‹å§‹")):::initNode
    INIT["Initialize State<br/>(initialize_state)<br/>çŠ¶æ…‹åˆæœŸåŒ–"]:::initNode
    TASK_GEN["Generate Task List<br/>(sas_user_input_to_task_list)<br/>ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆç”Ÿæˆ"]:::processNode
    REVIEW["Review and Refine<br/>(sas_review_and_refine)<br/>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æ”¹å–„"]:::reviewNode
    MODULE_STEPS["Generate Module Steps<br/>(sas_task_list_to_module_steps)<br/>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ç”Ÿæˆ"]:::processNode
    PARAM_MAP["Parameter Mapping<br/>(sas_parameter_mapping)<br/>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°"]:::processNode
    GEN_XML["Generate Individual XMLs<br/>(generate_individual_xmls)<br/>å€‹åˆ¥XMLç”Ÿæˆ"]:::processNode
    MERGE_XML["Merge XMLs<br/>(sas_merge_xmls)<br/>XMLçµåˆ"]:::processNode
    CONCAT_XML["Concatenate XMLs<br/>(sas_concatenate_xmls)<br/>XMLé€£çµ"]:::processNode
    ERROR["Error State<br/>ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹"]:::errorNode
    END(("Complete / å®Œäº†")):::endNode
    
    %% Define state transitions / çŠ¶æ…‹é·ç§»ã®å®šç¾©
    START --> INIT
    
    INIT -->|"Has User Input<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚ã‚Š"| TASK_GEN
    INIT -->|"Needs Review<br/>ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦"| REVIEW
    
    TASK_GEN -->|"Generation Success<br/>Needs Review<br/>ç”ŸæˆæˆåŠŸãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦"| REVIEW
    TASK_GEN -->|"Generation Failed<br/>ç”Ÿæˆå¤±æ•—"| ERROR
    TASK_GEN -->|"Direct End<br/>ç›´æ¥çµ‚äº†"| END
    
    REVIEW -->|"User Approved<br/>Continue Next Step<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãƒ»æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ç¶™ç¶š"| MODULE_STEPS
    REVIEW -->|"User Modified<br/>Regenerate Tasks<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿®æ­£ãƒ»ã‚¿ã‚¹ã‚¯å†ç”Ÿæˆ"| TASK_GEN
    REVIEW -->|"User Approved<br/>Direct XML Generation<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªãƒ»ç›´æ¥XMLç”Ÿæˆ"| GEN_XML
    REVIEW -->|"Cancel/Error<br/>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»ã‚¨ãƒ©ãƒ¼"| END
    
    MODULE_STEPS -->|"Generation Success<br/>Needs Review<br/>ç”ŸæˆæˆåŠŸãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦"| REVIEW
    MODULE_STEPS -->|"Generation Failed<br/>ç”Ÿæˆå¤±æ•—"| ERROR
    
    PARAM_MAP -->|"Mapping Success<br/>ãƒãƒƒãƒ”ãƒ³ã‚°æˆåŠŸ"| MERGE_XML
    PARAM_MAP -->|"Mapping Failed<br/>ãƒãƒƒãƒ”ãƒ³ã‚°å¤±æ•—"| ERROR
    
    GEN_XML -->|"Generation Success<br/>ç”ŸæˆæˆåŠŸ"| PARAM_MAP
    GEN_XML -->|"Generation Failed<br/>ç”Ÿæˆå¤±æ•—"| ERROR
    
    MERGE_XML -->|"Merge Success<br/>çµåˆæˆåŠŸ"| CONCAT_XML
    MERGE_XML -->|"Merge Failed<br/>çµåˆå¤±æ•—"| ERROR
    
    CONCAT_XML -->|"Complete<br/>å®Œäº†"| END
    
    ERROR -->|"Recoverable<br/>å¾©æ—§å¯èƒ½"| REVIEW
    ERROR -->|"Unrecoverable<br/>å¾©æ—§ä¸å¯èƒ½"| END
    
    %% Add dialog state labels / ãƒ€ã‚¤ã‚¢ãƒ­ã‚°çŠ¶æ…‹ãƒ©ãƒ™ãƒ«ã®è¿½åŠ 
    TASK_GEN -.->|"dialog_state:<br/>sas_step1_tasks_generated"| TASK_GEN
    REVIEW -.->|"dialog_state:<br/>sas_awaiting_task_list_review<br/>sas_awaiting_module_steps_review"| REVIEW
    MODULE_STEPS -.->|"dialog_state:<br/>sas_step2_module_steps_generated"| MODULE_STEPS
    CONCAT_XML -.->|"dialog_state:<br/>sas_step3_completed"| CONCAT_XML 